apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: busybox-rollout
  namespace: default
spec:
  replicas: 5
  strategy:
    canary:
      # Canary configuration
      canaryService: busybox-canary-service
      stableService: busybox-stable-service
      trafficRouting:
        nginx:
          stableIngress: busybox-ingress
          annotationPrefix: nginx.ingress.kubernetes.io
      # Canary steps
      steps:
      - setWeight: 20
      - pause: 
          duration: 30s
      - setWeight: 40
      - pause: 
          duration: 30s
      - setWeight: 60
      - pause: 
          duration: 30s
      - setWeight: 80
      - pause: 
          duration: 30s
      - setWeight: 100
  selector:
    matchLabels:
      app: busybox
  template:
    metadata:
      labels:
        app: busybox
    spec:
      containers:
      - name: busybox
        image: busybox:1.35
        command: ['sh', '-c']
        args: 
        - |
          echo "Starting busybox server..."
          echo "Version: v1.0"
          echo "Pod: $HOSTNAME"
          echo "Timestamp: $(date)"
          echo "Starting HTTP server on port 8080"
          while true; do
            echo -e "HTTP/1.1 200 OK\nContent-Type: text/html\n\n<html><body><h1>Busybox Server</h1><p>Version: v1.0</p><p>Pod: $HOSTNAME</p><p>Time: $(date)</p></body></html>" | nc -l -p 8080
          done
        ports:
        - containerPort: 8080
          name: http
        resources:
          requests:
            cpu: 100m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
